# EventBrighter - On RAILS Baby !

app link - [Eventbrighter](https://eventbrite-team.herokuapp.com)

This was a project to do on week 7 of our Fullstack Bootcamp (Hi THP !)


![](https://media.giphy.com/media/duNowzaVje6Di3hnOu/giphy-downsized-large.gif)

Dans ce projet, tu vas reprendre le projet de la veille pour y construire tes premi√®res vues. Tu vas installer Devise sur ton application et construire les premi√®res vues.

Plus en d√©tails, voici ce que nous attendons de toi :

    Tu dois installer Devise sur l'application, et brancher le model User √† Devise
    Tu vas brancher Bootstrap √† ton application
    Tu vas faire un header qui comprend les liens importants de ton application, puis le mettre pour toutes les vues de ton application
    Tu vas faire la page d'accueil du site
    Tu vas faire la page profil d'un utilisateur
    Tu vas faire la page de cr√©ation d'√©v√©nement
    Tu vas faire la page qui affiche un √©v√©nement

‚ÄãUn repo GitHub accueillant l'app Rails avec un maximum des fonctionnalit√©s ci-dessus. Le tout doit √™tre disponible sur Heroku (lien dans le README).

Avec ceci, tu as une belle application o√π les gens peuvent voir la liste des √©v√©nements disponibles dans leur ville. C'est un excellent d√©but et tu peux √™tre fier de toi.

Demain nous allons ajouter les fonctionnalit√©s pour rejoindre un √©v√©nement et ton application sera pr√™te et fonctionnelle pour √™tre montr√©e √† la Terre enti√®re. √Ä partir de jeudi on impl√©mentera des fonctionnalit√©s pas indispensables, mais qui vont agr√©menter l'exp√©rience utilisateur (gestion des images, interface administrateur).


![](https://media.giphy.com/media/Ri1zOvYjWaykpyhy30/giphy-downsized-large.gif)


This project was developed in peer programming with a part of the the Vocal_15 team : [@Chreees79](https://github.com/Chreees79) / [@GuillaumeBrthlt](https://github.com/GuillaumeBrthlt) / [@linahello](https://github.com/linahello) / [@LoiseauB](https://github.com/LoiseauB) / [@xko0](https://github.com/xko0) !



![](https://giphy.com/clips/fazeclan-celebration-birthday-happy-fWBiMUGXGHBECOJ50Q)




### How to acces



[Eventbrighter](https://eventbrite-team.herokuapp.com) - (https://eventbrite-team.herokuapp.com/)


![](https://media.giphy.com/media/CzbiCJTYOzHTW/giphy.gif)


Something to get into the mood [here](https://www.youtube.com/watch?v=fKKNPLowteY)



### Authors Details:



üë§ **the famous and infamous Vocal_15**

- [@Chreees79](https://github.com/Chreees79)
- [@GuillaumeBrthlt](https://github.com/GuillaumeBrthlt)
- [@linahello](https://github.com/linahello)
- [@LoiseauB](https://github.com/LoiseauB)
- [@xko0](https://github.com/xko0) !




### Show your support



[Un Dev A La Mer](http://www.devalamer.fr/)

Give us a ‚≠ê Star on GitHub ‚Äî it helps!

~~ https://github.com/linahello/Eventbrite_team ~~




## lnt√©grer Stripe version 2019

---

## 1. Introduction

Vous avez branch√© Stripe avec succ√®s sur votre app Rails ? Bien jou√© üî• !

Dans ce cas, sauf bug dans la Matrice, vous devriez aboutir √† une interface de paiement qui se pr√©sente comme ceci :

![Illustration Legacy](https://www.learndash.com/support/wp-content/uploads/2019/03/stripe-learndash-payment-modal-example-306x400.jpg)

Avec √ßa, vous pouvez d√©j√† vous amuser √† faire tout un tas de fake paiements sur votre site et voir le chiffre d'affaires s'accumuler sur votre dashboard Stripe üí∞

Tant que vous utiliserez les **clefs d'API Stripe r√©serv√©es au test**, ce sera toujours des donn√©es bidons, mais c'est quand m√™me d√©j√† la classe √† Dallas üòé

*Ceci √©tant dit...*

Ce que nous avons ici est la version de Stripe Checkout dite **"Legacy"**, a.k.a √† l'ancienne, pour le paiement en ligne.

Alors, dans les paragraphes qui suivent, je vous propose d'**int√©grer Stripe version 2019**, pour que vous ayez des formulaires de paiement BG sur votre site !



## 2. Historique et contexte

**Stripe Checkout Legacy...**

- √Ä l'√©poque o√π c'est sorti, c'√©tait sans nul doute un truc de dingos ü§Ø, qui a apport√© au fur et √† mesure une √¢pre concurrence au mastodonte [Paypal](https://www.paypal.com/fr/webapps/mpp/home) pour le paiement en ligne.
- Globalement, [l'impl√©mentation dans une app Rails](https://stripe.com/docs/legacy-checkout/rails) est plut√¥t (tr√®s) accessible, ce qui est avantageux pour nous autres moussaillons de THP si tant est que l'on souhaite se familiariser avec l'univers des APIs.

Mais aujourd'hui, **cette version pose 2 probl√®mes majeurs** :

- Niveau Webdesign, on ne va pas se mentir, √ßa semble **un poil vieillot tout √ßa**. *Je ne juge pas hein... Mais un peu quand m√™me* üôà Plus s√©rieusement, vous pouvez faire le test avec vos proches, et voir comment ils per√ßoivent le paiement via le bouton bleu turquoise, en comparaison √† d'autres standards plus actuels (Google Pay, Apple Pay etc.)

- Bien plus touchy encore que le c√¥t√© cosm√©tique, il se trouve que **les formulaires Legacy ne sont plus conformes aux [normes europ√©ennes](https://apresta.fr/blog/nouvelle-norme-de-paiement-sca/#:~:text=La%20norme%2C%20ou%20l'authentification,jour%2C%20d'autres%20pas.) en mati√®re de paiement en ligne** üò± Concr√®tement, sur Legacy, vous n'avez pas "3D Secure" (vous savez, le texto / notification de votre banque avant la suite du paiement en ligne). Donc imaginons que demain un client europ√©en de votre boutique en ligne passe par l√†, eh bien il est fort probable que ce soit directement sa banque qui fasse blocus lors de l'√©tape tant attendue du paiement.

La bonne nouvelle dans tout √ßa : Stripe a √©videmment pr√©vu le coup avec une **nouvelle version BG comme tout pour vos paiements en ligne üòé** :

![Illustration Legacy](https://stripe.com/img/docs/checkout/checkout-preview.png)



## 3. La ressource

Int√©grer Legacy sur Rails, c'est plut√¥t easy gr√¢ce au [tutoriel de Stripe](https://stripe.com/docs/legacy-checkout/rails) √† ce sujet. Par contre, pour partir sur la version 2019, je ne vous cache pas que c'est beaucoup plus complicado de savoir m√™me par o√π commencer...

![confused Travolta](https://media.giphy.com/media/g01ZnwAUvutuK8GIQn/source.gif)

No worries ! On va se refaire tout le cheminement en souplesse et d'ici peu vous saurez comment **Int√©grer Stripe version BG en 30 minutes top chrono.**

Parce qu'√† un moment donn√© on va pas se laisser aller avec Legacy sur notre app, c'est la team Rails ici quand m√™me üî•

### 3.1. Pas √† pas en vid√©o

Voici d'abord [un tutoriel vid√©o](https://www.youtube.com/watch?v=dzCEMMfx8cQ) qui reprend toute la logique, les pr√©-requis et les s√©quences concr√®tes de code qui vous permettront d'int√©grer la nouvelle version :

[![IMAGE ALT TEXT HERE](https://img.youtube.com/vi/dzCEMMfx8cQ/0.jpg)](https://www.youtube.com/watch?v=dzCEMMfx8cQ)

 I see you celles et ceux qui pr√©f√®rent l'√©crit, √ßa arrive juste apr√®s üòá

### 3.2. Pr√©-requis

Globalement, **on est quasi sur les m√™mes pr√©-requis techniques que ceux qui servent √† faire fonctionner Stripe Checkout Legacy**... Avec quelques nouveaut√©s tout de m√™me, ce serait pas dr√¥le sinon üòÅ

Bref, voici ce qu'il vous faut :

#### 3.2.1. Avoir un compte Stripe (merci Captain Obvious ‚ù§Ô∏è)

#### 3.2.2. R√©cup√©rer les clefs d'API

Si vous arrivez √† ceci sur votre propre tableau de bord Stripe, c'est bon signe. Vous pouvez r√©cup√©rer les 2 clefs d'API qui serviront √† mettre en route l'engin de paiement sur votre app :

![illustration dashboard Stripe](https://kinsta.com/fr/wp-content/uploads/sites/4/2018/05/vos-cles-api-stripe.png)

#### 3.2.3. *Nouveaut√©* - Ajouter un nom public d'entreprise √† votre compte Stripe

- Oui, √ßa peut para√Ætre chelou cette histoire, mais il faut imp√©rativement le faire, car ce nom appara√Ætra entre autres sur les formulaires de paiement nouvelle g√©n√©ration.
- Tant que vous serez sur des paiements fictifs r√©alis√©s via les clefs API de test, je ne vois vraiment pas o√π seraient les cons√©quences juridiques ici. Bref, vous pouvez y aller, m√™me avec un nom 100% certifi√© fake d√©di√© au test üëå
- Par contre, pour des paiements r√©els √©videmment la situation ne sera pas la m√™me üò¨ *Merci Captain Obvious, Epidode 2*
- Vous devriez trouver easy o√π effectuer cette configuration. En comparaison avec d'autres gros logiciels en ligne, le dashboard de Stripe est plut√¥t facile √† lire. Mais parce que √ßa me fait plaisir, voici [la manip](https://www.loom.com/share/3ae7add227b748308ee079ef2fa555fb) si besoin.

#### 3.2.4. Configurer un fichier .env

* Bon, √† ce stade vous connaissez la musique : vu qu'on est sur des infos assez sensibles avec les clefs d'API, mieux vaut les stocker en lieu s√ªr dans un fichier `.env`, avec le `.gitignore` qui va avec.
* Si besoin, vous pouvez toujours revenir sur [cette ressource en lien avec le projet Twitter](https://www.thehackingproject.org/fr/dashboard/courses/4/lessons/16) pour un tuto complet sur "dotenv" et un rappel de son utilit√©.

#### 3.2.5. Configurer l'initializer Stripe

* M√™me d√©marche que pour Legacy : il s'agit de cr√©er un fichier `stripe.rb` dans `config/initializers`. et d'y ajouter les lignes suivantes :

  ```
  Rails.configuration.stripe = {
    :publishable_key => ENV['PUBLISHABLE_KEY'],
    :secret_key      => ENV['SECRET_KEY']
  }Stripe.api_key = Rails.configuration.stripe[:secret_key]
  ```

* Bien entendu, il faudra que les d√©nominations `PUBLISHABLE_KEY` et/ou `SECRET_KEY` matchent avec les noms que vous avez choisis dans votre fichier `.env` pour stocker les clefs d'API.

#### 3.2.6. Ajouter la Gem "Stripe" dans votre Gemfile

On programme avec du Ruby, donc √©videmment qu'il y a une Gem qui va avec üíé

#### 3.2.7. *Nouveaut√©* - Appeler les scripts BG de Stripe dans votre code HTML

* Et pour finir, on va appeler une **librairie de ressources g√©r√©es directement par Stripe : des scripts JS** en b√©ton arm√© qui feront parfaitement le taff pour charger les formulaires de paiement en ligne BG sur votre page.

* Rien de foufou √† coder ici : dans `app/views/layouts/application`, vous pouvez juste ajouter ceci quelque part dans votre balise `<head>` :

```
<script src="https://js.stripe.com/v3/"></script>
```

---

##### Ca y est ! Tout est pr√™t pour brancher Stripe nouvelle g√©n√©ration sur votre app, √ßa m√©rite bien un petit meme des familles tout √ßa üòç

<a href="https://imgflip.com/i/4sp3yq" style><img src="https://i.imgflip.com/4sp3yq.jpg" title="made at imgflip.com"/></a> 



### 3.3. Impl√©mentation d'un "One-Time-Payment"

Allez, apr√®s toute cette mise en place, on va (enfin !) pouvoir coder concr√®tement la mise en route de l'engin de paiement sur notre app Rails üî•

#### 3.3.1. Cr√©er les routes vers la session de paiement

* Dans le fichier `config/routes.rb`, ajouter les lignes suivantes :

```
scope '/checkout' do
	post 'create', to: 'checkout#create', as: 'checkout_create'
	get 'success', to: 'checkout#success', as: 'checkout_success'
	get 'cancel', to: 'checkout#cancel', as: 'checkout_cancel'
end
```

* Que se passe-t-il avec ces lignes de code ?
  * La ligne `post 'create'` va repr√©senter la demande concr√®te de cr√©ation d'une session s√©curis√©e de paiement Stripe. Sch√©matiquement, cette requ√™te `POST` est envoy√©e √† notre serveur, qui "fait suivre" le tout √† Stripe via des appels d'API, qui lui-m√™me nous renverra du contenu √† l'√©cran.
  * Le syst√®me de Stripe veut que lors d'une session de paiement, on indique 2 URLs de redirection : une URL `success` sur laquelle on atterrit lorsque la session arrive √† son terme, et une URL `cancel` lorsque la session est annul√©e par le client ou que le paiement √©choue.
* Mais dis-donc Jamy, qu'est-ce que c'est que ce machin de `scope '/checkout'` ?
  * La notion de `scope`, tout comme celle de `namespace`, peut √™tre vue comme un "pack" de routes qui sera accompagn√© de son ou ses controllers.
  * Si le sujet vous branche, je vous laisse appr√©cier la [diff√©rence entre scope et namespace](https://devblast.com/b/rails-5-routes-scope-vs-namespace).
  * Ici, j'ai choisi le `scope` pour minimiser la quantit√© de code √† produire. Avec cette configuration de routes et un seul et unique controller `checkout`, j'aurai tout ce qu'il me faut pour ex√©cuter le paiement sur mon app.
* Et pourquoi ne pas avoir utilis√© ce bon vieux `resources` ici ?
  * Ca pourrait sembler √™tre une bonne id√©e... Mais en fait pas tant que √ßa üòÖ
  * Je m'explique : dans mon `scope` checkout, j'ai d√©j√† mes deux routes customis√©es `success`et `cancel`, qui sortent des clous si on utilise un `resources`.
  * Par ailleurs, en partant sur un `resources`, on cr√©e par d√©faut des actions "edit", "update", "delete" etc. qui n'ont pas vraiment lieu d'√™tre ici. [Bon chance](https://www.youtube.com/watch?v=cOsqUta2ol4&feature=youtu.be&t=45) si vous voulez permettre √† l'utilisateur d'√©diter ses infos de paiement sur Stripe avec un combo edit/update üòÖ
  * Bref, la seule route du sch√©ma de `resources` qui compte, c'est la ligne `post 'create'`, donc autant s'en contenter !

#### 3.3.2. Ajouter un bouton de paiement qui cr√©e la session Stripe

* √Ä ce stade, vous avez sans doute d√©j√† une view HTML disponible avec votre produit √† payer, ou alors un "panier" compos√© de plusieurs produits, si vous √™tes dans une logique de boutique en ligne.
* Voici donc du code que vous pouvez ajouter en bas de votre page HTML pour int√©grer un bouton de paiement cr√©ant la session Stripe :

```
<%= button_to "Passer commande (NEXT GEN)", checkout_create_path(total: MONTANT √Ä PAYER), class: "btn btn-primary", remote: true %>
```

* Quelques subtilit√©s :
  * `button_to` permet d'ex√©cuter sans probl√®me la requ√™te `POST`, a.k.a l'action de cr√©er la session. For some reason, si on met un `link_to` √ßa ne fonctionnera pas üò≠
  * Il est important ici de passer comme argument un `MONTANT √Ä PAYER`.
    * Charge √† chacun donc d'extraire le prix du produit/panier et de l'ins√©rer ici.
    * Dans le contexte de la boutique en ligne, nous avions cod√© ceci : `(total: @cart.total)`. Cela permettait de r√©cup√©rer le montant final du panier de l'utilisateur, afin que le paiement soit bas√© sur un prix coh√©rent.
    * Si vous ne l'avez pas encore cod√©, en attendant, vous pouvez toujours √©crire en dur : `(total: 10)`. De cette fa√ßon, le produit vaudra 10 euros dans le paiement effectu√© sur le formumaire Stripe.
  * Enfin, `remote: true` est une requ√™te AJAX, qui s'av√®rera indispensable pour "injecter" du code Javascript dans notre page HTML. Et ce code Javascript... est tout simplement le formulaire de paiement Stripe lui-m√™me ! Bref, impossible de s'en passer üòÅ

#### 3.3.3. Ecrire les m√©thodes du controller "checkout"

* On commence avec un petit `rails generate controller checkout` pour avoir le fichier √† disposition.
* Et voici donc ce que vous pouvez ajouter dans `app/controllers/checkout.rb` :

```
class CheckoutController < ApplicationController

	def create
    @total = params[:total].to_d
    @session = Stripe::Checkout::Session.create(
      payment_method_types: ['card'],
      line_items: [
        {
          name: 'Rails Stripe Checkout',
          amount: (@total*100).to_i,
          currency: 'eur',
          quantity: 1
        },
      ],
      success_url: checkout_success_url + '?session_id={CHECKOUT_SESSION_ID}',
      cancel_url: checkout_cancel_url
    )
    respond_to do |format|
      format.js # renders create.js.erb
    end
  end

  def success
    @session = Stripe::Checkout::Session.retrieve(params[:session_id])
    @payment_intent = Stripe::PaymentIntent.retrieve(@session.payment_intent)
  end

  def cancel
  end

end
```

* Quelques subtilit√©s :
  * Notre montant total √† payer, pass√© tout √† l'heure en argument dans le bouton de paiement, est de retour ici : `@total = params[:total].to_d`.
  * Comme indiqu√© pr√©c√©demment, le syst√®me Stripe demande de param√©trer des URLs de redirection `success` et `cancel`, que l'on retrouve cod√©es dans la m√©thode "create".
  * Le paragraphe `respond_to do...` reprend la requ√™te AJAX `remote: true` vue pr√©c√©demment, pour injecter du contenu Javascript dans la page `create.js.erb` , qui sera une sorte de "r√©ceptacle" √† notre formulaire de paiement.
  * Le code `@session` de la m√©thode "success" vise √† extraire de l'info sur la session de paiement qui vient d'avoir lieu. Le code `@payment_intent`, quant √† lui, vise √† extraire le montant qui a *r√©ellement* √©t√© pay√© par l'utilisateur. Logique, nous sommes sur la page `success`, donc forc√©ment cel√† signifie que l'utilisateur aura bien pay√© son produit.
* Mais dis-donc Jamy, pourquoi ne pas avoir mis de code `@payment_intent` dans la m√©thode "cancel", comme tu l'as fait dans la vid√©o ?
  * En effet cher viewer, votre vision d'aigle m'impressionne ! Dans le [pas √† pas en vid√©o](https://www.youtube.com/watch?v=dzCEMMfx8cQ), j'ai √©crit dans la m√©thode "cancel" du code tout √† fait √©quivalent √† "success".
  * *Et alors, c'√©tait une bonne id√©e ?* Oui, mais non üò± !
  * Je m'explique : quand un utilisateur est redirig√© sur "cancel", cela signifie :
    * Que le paiement a √©chou√© lors de la session.
    * **OU ALORS**, qu'il a simplement appuy√© sur un bouton "Annuler" qui appara√Æt quelque part sur le formulaire avant m√™me de proc√©der au paiement... Et voil√† pr√©cis√©ment tout le probl√®me de coder un `@payment_intent` ici : la session n'a jamais r√©ellement commenc√©, donc votre programme ne va rien capter si on lui demande tout √† coup de publier √† l'√©cran un `@payment_intent` qui n'existe pas üò¨
  * Bref, je vous laisse g√©rer cette m√©thode "cancel" du controller et y mettre du code plus ad√©quat si cela s'av√®re pertinent.

#### 3.3.4. Ajouter du contenu dans les views "checkout"

Allez, on y est presque ! Il ne nous reste plus qu'√† ajouter un peu de contenu dans un dossier `app/views/checkout` üî• Le code ci-dessous devrait parler de lui-m√™me :

- Fichier `create.js.erb`

```
const stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>');
stripe.redirectToCheckout({
  sessionId: '<%= @session.id %>'
}).then(function (result) {
  console.log(result.error.message);
});
```

- Fichier `success.html.erb`

<div class="container text-center my-5">
  <h1>Succ√®s</h1>
  <p>Nous avons bien re√ßu votre paiement de <%= number_to_currency(@payment_intent.amount_received / 100.0, unit: "‚Ç¨", separator: ",", delimiter: "", format: "%n %u") %>.</p>
  <p>Le statut de votre paiement est : <%= @payment_intent.status %>.</p>
</div>

- Fichier `cancel.html.erb`

<div class="container text-center my-5">
	<h1>Echec</h1>
  <p>Le paiement n'a pas abouti.</p>
</div>

---

**Et voil√† ! Vous pouvez tester : sauf bug majeur dans la Matrice, vous avez maintenant un engin de paiement Stripe nouvelle g√©n√©ration et fonctionnel branch√© sur votre app Rails üéâüéâüéâ**

![confused Travolta](https://media.giphy.com/media/8Iv5lqKwKsZ2g/source.gif)



## 4. Points importants √† retenir

- Stripe Checkout Legacy... 
  - C'est tr√®s bien pour d√©couvrir l'univers du paiement en ligne Stripe et se familiariser avec la gestion des APIs sur votre app Rails.
  - En revanche, le syst√®me de paiement lui-m√™me est obsol√®te, ou en passe de le devenir tr√®s prochainement.
- Autrement dit, si vous souhaitez mettre en route un syst√®me de paiement en ligne viable sur votre site, pas le choix, il va vous falloir migrer de la version Legacy vers la version 2019, ou impl√©menter cette derni√®re directement.
- Pour brancher cette nouvelle version sur Rails, je ne vous cache pas que l'info n'est clairement pas des plus accessibles. Je vous invite donc √† voir ou revoir le [pas √† pas en vid√©o](https://www.youtube.com/watch?v=dzCEMMfx8cQ), ou suivre les √©tapes de cette ressource pour y parvenir sans difficult√©.
- Si l'univers de Stripe vous int√©resse et que vous souhaitez aller plus loin dans l'impl√©mentation, je serais ravi de vous fournir d'autres infos pour vous aider. Voici mon contact sur Discord : [Quentin PLAUD](Quentin PLAUD#7166). Autant que les heures pass√©es en t√™te-√†-t√™te avec la documentation Stripe, les repos GitHub ou autres r√©jouissances servent au plus grand nombre üòÅ 

## 5. Pour aller plus loin

Dans cette ressource, on est sur le mod√®le de paiement en ligne le plus basique qui soit : le **"One-time payment"**. Par ailleurs, l'impl√©mentation que je vous ai propos√©e est volontairement [minimaliste](https://www.welcometothejungle.com/fr/articles/minimalisme-travail-productivite-epanouissement) en termes de lignes de code. Rome ne s'est pas faite en un jour, et le branchement de la version 2019 est d√©j√† suffisamment ü§Øü§Øü§Ø comme √ßa. Bref, autant commencer par l√† avant d'aborder la suite !

Ceci √©tant dit, vous pouvez √™tre certains que Stripe dispose de possibilit√©s assez dingues, que je vous invite √† d√©couvrir si vos objectifs et votre app√©tence s'y pr√™tent. En voici un petit avant-go√ªt :

- Synchroniser un Stripe ID avec vos diff√©rents produits et utilisateurs de votre app, pour pouvoir suivre statistiquement tout ce qui se rapporte aux paiements, dans votre base de donn√©es comme sur le tableau de bord Stripe.
- Automatiser la gestion des factures.
- Int√©grer un "webhook" √† votre s√©quence de paiement. Pour un ordre d'id√©e, c'est une sorte de partie de ping-pong qui s'engage entre votre serveur et celui de Stripe. Je n'ai pas trouv√© mieux pour imager üòÖ
- Int√©grer un mod√®le de paiement d'abonnement, dont Stripe coordonne la temporalit√©.
- ...
